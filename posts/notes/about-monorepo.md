---
title: 关于对monorepo的思考
meta:
  - name: 'about-monorepo'
    content: 'about-monorepo'
    date: 2022-06-19T13:10:49.955Z
---

在几个月前我曾经发布了一片关于如何参与开源项目的博文。里面也提到了`monorpeo`。但是在我使用了很长的一段时间我对其的看法有点其他的理解了。

构建一个`monorepo`的方式有许多。比如`lerna`,`pnpm`,`nx`,`rush`之类的。这里不谈工具的好坏优劣。只讨论对于`monorepo`的构想。


### 我到底要不要选择`monorepo`

很多时候对于技术的盲目追求我们很容易陷入一个不好的方向那就是人多这样用那么一定就是对的。当项目日益复杂的时候回过头来审视他们却发现已经很难改了。
比如我的项目只是有几个小模块。那我大可不必做成`monorepo`.这样只会增加项目的复杂程度。也许你需要的只是`alias`去解决这件事。那么如果你还是认为你需要
`monorepo`那么怎么划分一个模块才是需要注意的点。


### 模块的划分

`fect`在早期迁移`monorepo`的时候也犯过这个错。那就是`anything in packages`。想必我们在创建一个`monorepo`的时候都习惯性的把`sub package`放到`packages`下。
但是这是一种很不好的习惯。因为如果你有内置`cli`的时候你会发现你的链路非常的长。你往往需要`yarn && yarn clean && yarn`这样的方式对`cli`重新安装。这时候我更建议
把`cli`单独拆出来作为一个独立的仓库进行维护(如果他真的很有必要的话)。如果你没有这一方面的刚需我的建议是把他们放在`internal`目录下放一些内部模块。`pacakges`目录无论何时
只存放需要发布的模块。这样可以保证目录的模块职责分明。减少过于庞大的编译链路往往可以做到`clean and powerful`。从根源上减少了复杂度保证了项目的健壮性。

### 一份`monorepo`的目录结构建议

<p>
 <fe-dot>
    <b>packages</b> 存放需要发布的模块
 </fe-dot>
</p>

<p>
 <fe-dot type="success">
    <b>internal</b> 内部的一些服务模块(不随着模块发布而暴露的模块)
 </fe-dot>
</p>

<p>
 <fe-dot type="warning">
    <b>docs</b> 存放包的文档相关
 </fe-dot>
</p>

<p>
 <fe-dot type="error">
    <b>website</b> 站点配置(如果他真的有必要的话)
 </fe-dot>
</p>


### 关于依赖

多提一嘴。很多时候在使用`monorepo`的时候往往可以享受到幽灵依赖的好处。幽灵依赖也不是洪水猛兽。你要注意的是他只在你的可见范围可控而不影响需要发布的包的时候。你在大量使用他们作为
`internal module`他们就是合理的,没必要像网上各种对其口伐笔诛,你需要有你自己的主观判断。存在即合理怎么用好他们才是你需要考虑的。