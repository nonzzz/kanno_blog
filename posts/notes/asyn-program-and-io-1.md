---
title: NodeJS异步编程与IO-1
meta:
  - name: asyn-program-and-io-1
    content: asyn-program-and-io-1
---

`Web`的发展日新月异,单机时代下已经难以在满足我们的开发需要,跨网络的架构下,并发编程已经成为了一个标准,具体到用户体验资源分发。

## 用户体验

在`Web2.0`的时代下,作为前端从业者异步操作往往伴随着我们,比如经常用到的`AJAX`,但是我们是否想过为什么我们需要`AJAX`,因为`XHR`是可以同步的。因为`javaScript`是单线程语言,在浏览器上他和`UI`渲染共享了一个线程,那么试问如果没有
`AJAX`只有`Sync`的`XHR`势必会带来以下的情况。我们假设有个获取数据的服务他是同步获取的,那么这时候我们这个线程就会发生阻塞,如果响应时间超过了`1000ms`这时候是会造成页面的明显卡顿的,因为你在从服务端获取资源加载的过程阻塞了这条
线程,那么`UI`的渲染必然推后,这对于用户体验是灾难性的因此我们才需要可以`Async`的`AJAX`。
假设我们有多个不同的资源来自不同的服务器他们的响应速度是不一致的,那么如果是同步的方式他的响应到渲染总和就是`a +...+ n`,那么异步就是`Math.max(a,...,n)`。随着业务的复杂度随着时间日渐增长,那么我们可以通过这 2 种模型可以看到异步的
好处是显而易见的。因为现代的编程往往不是单机能够胜任的必然是分布式的架构设计。

## 资源的分配

上述内容我们阐述了异步编程在前端的好处,这一节我将从服务端的角度描述下资源的分配。无论在前端还是后端,我们处理资源的方式有以下两种方式:

- 单线程串行
- 多线程并行

单线程的模型是最贴近人类思考的,我们可以以一种同步的方式去编写代码,那么既然是同步就会发生阻塞当前任务没执行完毕就无法执行下一个任务,这必然造成 cpu 资源的浪费。于是多线程编程登上了舞台,我们可以利用多个线程去处理任务,但是我们需要
控制线程间的同步问题,锁和竞态会让我们头疼不已,而且他也没法把任务分发到多个进程下,总体的时间切片还是被拉长了,因此我们堆叠了更多的服务器去处理这些问题,显然这是一个治标不治本的方案。因此我们陷入了思考我们该如何更好的利用服务器去做更多的事情提升我们的用户体验于是我们把目光瞄准了异步编程。

## 阻塞与非阻塞

我们或许多多少少听过异步非阻塞,同步阻塞。但是实际上同步和异步,阻塞和非阻塞是两回事。对于内核而言只有阻塞与非阻塞。在调用阻塞 I/O,应用程序需要等待 I/O 完成后才返回结果,这段时间 cpu 的处理能力得不到充分的利用与之相反的非阻塞 I/O 则不需要等待返回结果因此性能大大提升。我们以`nodejs`中的`fs.readFileSync`和`fs.readFile`这 2 个`API`作为举例说明。

```js
const fs = require('fs')

try {
  const data = fs.readFileSync('./1.txt', 'utf-8')
  console.log(data)
} catch (err) {
  console.log(err)
}

fs.readFile('./1.txt', 'utf-8', (err, result) => {
  if (err) cosole.log(err)
  console.log(result)
})
```

上述代码段我们分别以同步和异步的方式读取了文件,这时候让我们看看他们 2 分别发生了什么。我们在应用层分别调用了代码,在阻塞 I/O 的模式下我们需要等待数据的结果返回,而在非阻塞 I/O 的模式下我们得到的是一个文件描述符,这时候 cpu 就空闲下来了他就可以继续去处理别的事情,此时的性能提升是显著的。但是也因此埋下了伏笔,我们得到的数据并不完整,因为 I/O 没有完全执行完毕。那么我们又是如何获取到数据的呢?为了获取数据,应用程序需要反复的请求 I/O,这种我们也称之为轮询,但是轮询也并非完美,他会通过判断 I/O 状态消耗 cpu。那么我们又该如何降低他带来的副作用呢?

## 线程池

NodeJS 是一门单线程语言,但是 NodeJS 提供了`libuv`降低了轮询的副作用,正如`libuv`自己描述的一样他屏蔽了平台的细节提供了异步/IO 的支持。通俗的来说`libuv`就是一个线程池,我们在线程池上完成我们的 I/O 操作然后在通过线程间的通信将 I/O 数据进行传递这样就显著了减少了主线程的影响。NodeJS 的优秀性能也得益于此。这里我要强调一点`NodeJs`仅仅只是`Js`运行在单线程,所有的 I/O 操作都是交给了其他的线程进行处理。

下文,<fe-link to="/notes/asyn-program-and-io-2">`NodeJS异步编程与IO-2`</fe-link>
